# 自动化测试平台 - 执行器客户端

## 概述

执行机是自动化测试平台的任务执行组件，负责接收并执行从平台下发的测试任务。执行机通过 RabbitMQ 消息队列接收任务，通过 HTTP API 上报执行结果和心跳状态。

## 系统要求

### 必需环境
- **Python**: 3.8 或更高版本
- **RabbitMQ**: 3.8 或更高版本（用于消息队列）
- **浏览器**: Chrome/Firefox/Edge（根据需要安装）

### 浏览器驱动
根据使用的浏览器，需要安装对应的驱动：

| 浏览器 | 驱动 | 下载地址 |
|--------|------|----------|
| Chrome | ChromeDriver | https://chromedriver.chromium.org/ |
| Firefox | GeckoDriver | https://github.com/mozilla/geckodriver |
| Edge | MSEdgeDriver | 通常随 Edge 浏览器自动安装 |

## 安装

### 方式一：安装包安装（推荐）

1. 双击运行 `executor-setup-x.x.x.exe`
2. 按照安装向导完成安装
3. 首次运行会自动启动配置向导
4. 配置服务器地址和账号信息

### 方式二：手动安装

1. 解压执行机文件到目标目录
2. 安装依赖：`pip install -r requirements.txt`
3. 运行：`python main.py`

## 配置

执行机配置文件位于：`~/.executor/config.json`

### 配置项说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| server_url | 平台服务器地址 | http://127.0.0.1:8000 |
| executor_name | 执行机名称 | - |
| owner_username | 平台用户名 | - |
| owner_password | 平台密码 | - |
| max_concurrent | 最大并发任务数 | 3 |
| default_browser | 默认浏览器 | chrome |
| rabbitmq_host | RabbitMQ 地址 | 127.0.0.1 |
| rabbitmq_port | RabbitMQ 端口 | 5672 |
| heartbeat_interval | 心跳间隔（秒） | 30 |

## 连接配置

### 本地连接（执行机与服务器同电脑）

如果执行机和服务器在同一台电脑上，可以使用默认的 `guest` 账号：

```
服务器地址: http://127.0.0.1:8000
RabbitMQ地址: 127.0.0.1
用户名: guest
密码: guest
```

### 远程连接（执行机与服务器不同电脑）

由于 RabbitMQ 的 `guest` 账号只允许本地连接，远程执行机需要使用专用的 RabbitMQ 用户：

#### 第一步：创建 RabbitMQ 用户

1. 使用超级管理员账号登录平台
2. 进入「账号角色管理」→「角色管理」标签页
3. 在「RabbitMQ 用户管理」区域点击「创建 RabbitMQ 用户」
4. 填写用户名（如 `executor-remote-01`）和密码
5. 点击创建，系统会显示凭证信息

#### 第二步：配置执行机

在配置向导中填写：

```
服务器地址: http://[服务器IP]:8000
RabbitMQ地址: [服务器IP]
用户名: [刚创建的用户名]
密码: [创建时设置的密码]
```

**重要提示**：
- 如果服务器和执行机在不同电脑，需要填写服务器的实际IP地址
- 不能使用 `127.0.0.1` 或 `localhost`（这会指向执行机自己）
- 确保服务器的防火墙允许 8000 端口（API）、5672 端口（RabbitMQ）的访问

## 使用

### 启动执行机

双击桌面快捷方式或开始菜单中的"自动化测试执行机"。

### 连接服务器

1. 确保平台服务已启动
2. 确保 RabbitMQ 服务已启动
3. 点击"连接服务器"按钮
4. 连接成功后状态显示为"已连接"

### 查看任务状态

- **当前任务**：显示正在执行和最近完成的任务
- **统计信息**：显示总任务数、成功数、失败数、资源使用情况

### 开机自启动

在安装向导中可以选择是否开机自启动。如需修改：

1. 打开任务计划程序（Windows）
2. 找到"自动化测试执行机"任务
3. 启用或禁用该任务

## 日志

### 日志位置

- 控制台日志：执行机窗口
- 文件日志：`~/.executor/logs/`

### 日志级别

- WARNING：警告信息（默认）
- ERROR：错误信息
- INFO：详细信息
- DEBUG：调试信息

修改日志级别：编辑配置文件中的 `log_level` 字段。

## 故障排查

### 问题：无法连接服务器

**原因**：
- 平台服务未启动
- RabbitMQ 服务未启动
- 网络配置问题
- 防火墙阻止连接
- 使用了错误的连接地址

**解决方案**：
1. 检查平台服务是否运行：访问 `http://服务器地址:8000`
2. 检查 RabbitMQ 是否运行：访问 `http://服务器地址:15672`（管理界面）
3. 检查配置文件中的服务器地址是否正确
4. 检查防火墙设置
5. **远程连接时**：确认使用的是服务器的实际IP，而非 127.0.0.1

### 问题：RabbitMQ 认证失败

**症状**：日志显示 `AMQPConnectionError` 或 `AuthenticationError`

**原因**：
- 使用了 `guest` 账号进行远程连接（guest 只允许本地）
- 用户名或密码错误

**解决方案**：
1. 联系超级管理员创建专用的 RabbitMQ 用户
2. 在平台「账号角色管理」→「角色管理」中创建用户
3. 使用专用账号重新配置执行机

### 问题：无法启动浏览器

**原因**：
- 浏览器未安装
- 浏览器驱动版本不匹配
- 浏览器路径配置错误

**解决方案**：
1. 确认浏览器已安装
2. 下载与浏览器版本匹配的驱动
3. 在配置向导中设置正确的浏览器和驱动路径

### 问题：任务执行失败

**原因**：
- 脚本配置错误
- 元素定位失败
- 网络超时
- 测试页面问题

**解决方案**：
1. 查看日志获取详细错误信息
2. 在平台查看脚本详情
3. 使用浏览器开发者工具检查元素定位

### 问题：心跳上报失败

**症状**：平台显示执行机离线

**原因**：
- 平台服务未启动
- server_url 配置错误
- 网络连接问题

**解决方案**：
1. 确认平台服务正常运行
2. 检查配置中的 server_url
3. 尝试在浏览器访问配置的 server_url

## 网络配置示例

### 场景一：服务器和执行机在同一电脑

```
服务器地址: http://127.0.0.1:8000
RabbitMQ地址: 127.0.0.1
用户名: guest
密码: guest
```

### 场景二：执行机在局域网其他电脑

假设服务器IP为 `192.168.1.100`：

```
服务器地址: http://192.168.1.100:8000
RabbitMQ地址: 192.168.1.100
用户名: executor-01  # 由超级管理员创建
密码: [创建时设置的密码]
```

**服务器端需要**：
- 确保防火墙允许 8000、5672 端口访问
- 创建专用的 RabbitMQ 用户

### 场景三：通过互联网连接

```
服务器地址: http://your-domain.com 或 http://公网IP:8000
RabbitMQ地址: your-domain.com 或 公网IP
用户名: executor-remote  # 由超级管理员创建
密码: [强密码]
```

**服务器端需要**：
- 配置端口转发/路由规则
- 配置 HTTPS（推荐）
- 创建强密码的 RabbitMQ 用户
- 考虑使用 VPN 提高安全性

## 安全建议

1. **不要在公网环境使用 guest 账号**
2. **为远程执行机创建专用用户并使用强密码**
3. **生产环境建议使用 HTTPS 和 VPN**
4. **定期更换 RabbitMQ 用户密码**
5. **限制执行机的网络访问权限**

## 技术支持

- 项目地址：https://github.com/your-org/auto-test-platform
- 问题反馈：https://github.com/your-org/auto-test-platform/issues

## 版本历史

### v1.1.0 (2026-02-11)
- 支持通过平台管理 RabbitMQ 用户
- 支持远程执行机连接
- 改进配置向导体验

### v1.0.0 (2024-02-08)
- 初始版本
- 支持 Selenium WebDriver
- 支持 RabbitMQ 消息队列
- 支持 HTTP 心跳上报
- 支持多浏览器执行
